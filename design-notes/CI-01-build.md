# CI-01: Build Pipeline Design
**STATUS**: Done

## Overview

This document describes the CI/CD pipeline design for the Dottie project.

## Core Tools

- **GitHub Actions** - CI/CD platform
  - Runner: `ubuntu-latest`
- **GitVersion** - Semantic versioning based on git history
- **Tags** - Applied on successful builds from `main`
- **.NET SDK** - Version specified in `global.json` (currently targeting net10.0)

> **Note:** Create `global.json` in repo root to pin the .NET SDK version for CI consistency.

## Versioning Strategy

- **Mode:** Mainline
- **Starting Version:** 0.1.0
- **Version Bumping:** Commit message conventions
  - `+semver: major` or `+semver: breaking` → major bump (1.0.0 → 2.0.0)
  - `+semver: minor` or `+semver: feature` → minor bump (1.0.0 → 1.1.0)
  - Default (no keyword) → patch bump (1.0.0 → 1.0.1)

## Build Triggers

| Trigger | Build | Unit Tests | Integration Tests | Artifacts | Tag |
|---------|-------|------------|-------------------|-----------|-----|
| Pull Request | ✅ | ✅ | ✅ | ✅ (downloadable) | ❌ |
| Push to `main` | ✅ | ✅ | ✅ | ✅ | ✅ |

## Build Stages

**Sequential pipeline (single job):**

1. **Checkout** - Clone repository with full history (needed for GitVersion)
2. **GitVersion** - Calculate semantic version from git history
3. **Restore** - `dotnet restore`
4. **Build** - `dotnet build` with version from GitVersion
5. **Unit Tests** - `dotnet test` with coverage collection
6. **Integration Tests** - `dotnet test` with coverage collection
7. **Coverage Report** - Generate and upload coverage report
8. **Publish** - `dotnet publish` for linux-x64 and win-x64
9. **Upload Artifacts** - Store binaries as workflow artifacts
10. **[main only] Tag + Release** - Create git tag and GitHub Release with binaries

## Artifacts

**Target Platforms:**
- `linux-x64`
- `win-x64`

**Output:** Self-contained executables (single file, trimmed)

**Storage:**
- PR builds → GitHub Actions artifacts (downloadable from workflow run)
- Main builds → GitHub Actions artifacts + **GitHub Release**

**Code Coverage:**
- Report uploaded as GitHub Actions artifact
- Summary posted as PR comment (using ReportGenerator)
- **Minimum threshold: 80%** — Build fails if coverage drops below this

## Releases

- A **GitHub Release** is created automatically when `main` builds successfully
- Release is tagged with the GitVersion-calculated version (e.g., `v1.2.3`)
- Release name: `v1.2.3` (version only)
- Release notes: Auto-generated by GitHub (from merged PRs/commits since last release)
- Release includes platform-specific binaries as downloadable assets:
  - `dottie-linux-x64`
  - `dottie-win-x64.exe`

## Tagging Strategy

- **Format:** `v{major}.{minor}.{patch}` (e.g., `v0.1.0`, `v1.2.3`)
- **Timing:** Created automatically after successful build on `main`
- **Trigger:** Tag creation triggers GitHub Release creation

## Branch Protection Rules

**For `main` branch:**
- ✅ Require CI status checks to pass before merging
- ✅ Require branch to be up-to-date before merging
- ❌ No approval requirement (0 reviewers)

---

## Design Decisions

**Workflow File:** `.github/workflows/build.yml`

**Caching:** NuGet packages cached for faster restore
