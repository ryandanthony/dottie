# Data Model: CI/CD Build Pipeline

**Feature**: 002-ci-build  
**Date**: January 28, 2026  
**Purpose**: Define the structure and relationships of pipeline components

## Workflow Structure

### Pipeline Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                     GitHub Actions Workflow                      │
│                        (build.yml)                               │
├─────────────────────────────────────────────────────────────────┤
│  Triggers:                                                       │
│  • pull_request → main                                          │
│  • push → main                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Job: build                            │   │
│  │                  (ubuntu-latest)                         │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  1. Checkout (full history)                             │   │
│  │           ↓                                              │   │
│  │  2. Setup .NET SDK                                       │   │
│  │           ↓                                              │   │
│  │  3. Cache NuGet packages                                │   │
│  │           ↓                                              │   │
│  │  4. GitVersion (calculate version)                      │   │
│  │           ↓                                              │   │
│  │  5. Restore dependencies                                │   │
│  │           ↓                                              │   │
│  │  6. Build (with version)                                │   │
│  │           ↓                                              │   │
│  │  7. Unit Tests (with coverage)                          │   │
│  │           ↓                                              │   │
│  │  8. Integration Tests (Docker)                          │   │
│  │           ↓                                              │   │
│  │  9. Coverage Report                                      │   │
│  │           ↓                                              │   │
│  │  10. Coverage Threshold Check (80%)                     │   │
│  │           ↓                                              │   │
│  │  11. Publish linux-x64                                  │   │
│  │           ↓                                              │   │
│  │  12. Publish win-x64                                    │   │
│  │           ↓                                              │   │
│  │  13. Upload Artifacts                                   │   │
│  │           ↓                                              │   │
│  │  14. Post Coverage Comment (PR only)                    │   │
│  │           ↓                                              │   │
│  │  15. Create Tag + Release (main only)                   │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Entities

### Version (GitVersion Output)

| Field | Type | Description |
|-------|------|-------------|
| Major | int | Major version number |
| Minor | int | Minor version number |
| Patch | int | Patch version number |
| SemVer | string | Full semantic version (e.g., "1.2.3") |
| FullSemVer | string | Full version with metadata (e.g., "1.2.3+5") |
| InformationalVersion | string | Version with branch info |

**Calculated by**: GitVersion based on git history and commit messages  
**Used by**: Build step (AssemblyVersion), Tag creation, Release naming

### Artifact

| Field | Type | Description |
|-------|------|-------------|
| Name | string | Artifact name (e.g., "dottie-linux-x64") |
| Platform | enum | Target platform (linux-x64, win-x64) |
| Path | string | Local path to published binary |
| Size | int | File size in bytes |

**Created by**: `dotnet publish` step  
**Uploaded to**: GitHub Actions artifacts (7-day retention)  
**Attached to**: GitHub Release (main branch only)

### Coverage Report

| Field | Type | Description |
|-------|------|-------------|
| LineCoverage | decimal | Percentage of lines covered (0-100) |
| BranchCoverage | decimal | Percentage of branches covered (0-100) |
| ReportPath | string | Path to generated HTML report |
| SummaryPath | string | Path to markdown summary |
| Threshold | decimal | Required minimum (80%) |
| Passed | bool | Whether coverage meets threshold |

**Generated by**: coverlet (collection) + ReportGenerator (formatting)  
**Posted to**: PR comment (deleted/recreated each run)

### Release

| Field | Type | Description |
|-------|------|-------------|
| TagName | string | Git tag (e.g., "v1.2.3") |
| Name | string | Release title (same as tag) |
| Body | string | Auto-generated release notes |
| Draft | bool | Always false (published immediately) |
| Prerelease | bool | true if version < 1.0.0 |
| Assets | Artifact[] | Platform binaries attached |

**Created by**: softprops/action-gh-release action  
**Triggered by**: Successful main branch build

### Branch Protection

| Field | Type | Description |
|-------|------|-------------|
| Branch | string | Protected branch name ("main") |
| RequireStatusChecks | bool | true - CI must pass |
| RequireUpToDate | bool | true - branch must be current |
| StatusChecks | string[] | ["build"] - required check names |
| EnforceAdmins | bool | true - rules apply to admins |

**Configured by**: Set-BranchProtection.ps1 script  
**API**: GitHub REST API /repos/{owner}/{repo}/branches/{branch}/protection

## State Transitions

### Build States

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│ Pending  │────▶│ Running  │────▶│ Success  │
└──────────┘     └──────────┘     └──────────┘
                      │                 │
                      ▼                 │ (main only)
                 ┌──────────┐           │
                 │ Failure  │           ▼
                 └──────────┘     ┌──────────┐
                                  │ Released │
                                  └──────────┘
```

### Coverage Comment States (PR only)

```
┌────────────────┐     ┌──────────────────┐     ┌────────────────┐
│ No Comment     │────▶│ Find & Delete    │────▶│ Post New       │
│ Exists         │     │ Old Comment      │     │ Comment        │
└────────────────┘     └──────────────────┘     └────────────────┘
```

## File Outputs

| Step | Output File | Retention |
|------|-------------|-----------|
| Unit Tests | TestResults/unit/**/coverage.cobertura.xml | Workflow run |
| Integration Tests | TestResults/integration/**/coverage.cobertura.xml | Workflow run |
| Coverage Report | coverage-report/index.html | 7 days (artifact) |
| Coverage Summary | coverage-report/Summary.md | 7 days (artifact) |
| linux-x64 Binary | publish/linux-x64/dottie | 7 days (artifact) / Permanent (release) |
| win-x64 Binary | publish/win-x64/dottie.exe | 7 days (artifact) / Permanent (release) |

## Environment Variables

| Variable | Source | Used By |
|----------|--------|---------|
| GITHUB_TOKEN | GitHub Actions | Release creation, PR comments |
| GitVersion_SemVer | GitVersion step | Build, tag creation |
| GitVersion_Major | GitVersion step | Build metadata |
| GitVersion_Minor | GitVersion step | Build metadata |
| GitVersion_Patch | GitVersion step | Build metadata |
